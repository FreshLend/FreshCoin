{% extends "base.html" %}

{% block title %}{{ _('Dashboard - FreshCoin') }}{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="row g-4">
        <div class="col-xl-4 col-lg-5">
            <div class="card profile-card h-100">
                <div class="card-body text-center">
                    <div class="position-relative d-inline-block mb-4">
                        <div class="holographic-frame"></div>
                        <img src="{{ user.avatar_path|avatar_url }}"
                             alt="{{ _('Avatar') }}" class="rounded-circle avatar-img shadow" width="120" height="120">
                    </div>
                    <h3 class="profile-name mb-3">{{ user.display_name or user.username }}</h3>
                    <div class="balance-card p-4 rounded holographic-screen">
                        <h2 class="mb-3">{{ _('Your Balance') }}</h2>
                        <h1 class="display-4 fw-bold">{{ "%.2f"|format(user.balance) }} <small class="fs-6">FC</small></h1>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-8 col-lg-7">
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h4 class="mb-0"><i class="fas fa-money-bill-wave me-2 glow"></i>{{ _('Earn FreshCoins') }}</h4>
                        </div>
                        <div class="card-body">
                            {% if can_watch %}
                                <div class="alert alert-info">
                                    <p class="mb-1">{{ _('You can earn between') }} <strong>0.1</strong> {{ _('and') }} <strong>1.0 FC</strong> {{ _('per ad watched!') }}</p>
                                    <p class="mb-0">{{ _('Daily limit:') }} <strong>{{ remaining_ads }}/100</strong> {{ _('ads remaining') }}</p>
                                </div>
                                
                                <button id="watchAdBtn" class="btn btn-primary btn-lg w-100 pulse">
                                    <i class="fas fa-play-circle me-2"></i>{{ _('Watch Ad & Earn FC') }}
                                </button>
                                <div id="resultMessage" class="mt-3"></div>
                            {% else %}
                                <div class="alert alert-secondary">
                                    <h5 class="alert-heading"><i class="fas fa-ban me-2"></i>{{ _('Daily Limit Reached') }}</h5>
                                    <p>{{ _("You've watched 100 ads today. Come back tomorrow to earn more FC!") }}</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h4 class="mb-0"><i class="fas fa-paper-plane me-2 glow"></i>{{ _('Send Currency') }}</h4>
                        </div>
                        <div class="card-body">
                            <form id="transferForm">
                                <div class="mb-3">
                                    <label for="recipient" class="form-label">{{ _('Recipient (Username or ID)') }}</label>
                                    <input type="text" class="form-control" id="recipient" name="recipient" placeholder="{{ _('Enter username or ID') }}" required>
                                </div>
                                <div class="row g-2 mb-3">
                                    <div class="col-8">
                                        <label for="transferCurrency" class="form-label">{{ _('Currency') }}</label>
                                        <select class="form-select" id="transferCurrency" name="currency">
                                            <option value="FC">{{ _('FreshCoin (FC)') }}</option>
                                        </select>
                                    </div>
                                    <div class="col-4">
                                        <label for="amount" class="form-label">{{ _('Amount') }}</label>
                                        <input type="number" step="0.01" min="0.01" class="form-control" id="amount" name="amount" placeholder="0.00" required>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success w-100">{{ _('Send') }}</button>
                            </form>
                            <div id="transferResult" class="mt-3"></div>
                        </div>
                    </div>
                </div>
                
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="mb-0"><i class="fas fa-exchange-alt me-2 glow"></i>{{ _('Currency Exchange') }}</h4>
                        </div>
                        <div class="card-body">
                            <form id="exchangeForm">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label for="fromCurrency" class="form-label">{{ _('From') }}</label>
                                        <select class="form-select" id="fromCurrency" name="from_currency" required>
                                            <option value="FC">{{ _('FreshCoin (FC)') }}</option>
                                            <!-- Will be populated dynamically -->
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="toCurrency" class="form-label">{{ _('To') }}</label>
                                        <select class="form-select" id="toCurrency" name="to_currency" required>
                                            <option value="FC">{{ _('FreshCoin (FC)') }}</option>
                                            <!-- Will be populated dynamically -->
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="exchangeAmount" class="form-label">{{ _('Amount') }}</label>
                                        <input type="number" step="0.0001" min="0.0001" class="form-control" id="exchangeAmount" name="amount" placeholder="0.00" required>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button type="submit" class="btn btn-warning w-100">{{ _('Exchange') }}</button>
                                    </div>
                                </div>
                            </form>
                            <div id="exchangeResult" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fas fa-coins me-2 glow"></i>{{ _('Create New Currency') }}</h4>
                </div>
                <div class="card-body">
                    <form id="createCurrencyForm">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="currencyName" class="form-label">{{ _('Currency Name') }}</label>
                                <input type="text" class="form-control" id="currencyName" name="name" placeholder="{{ _('e.g., MyCoin') }}" required>
                            </div>
                            <div class="col-md-3">
                                <label for="currencySymbol" class="form-label">{{ _('Symbol') }}</label>
                                <input type="text" class="form-control" id="currencySymbol" name="symbol" placeholder="{{ _('e.g., MC') }}" maxlength="10" required>
                            </div>
                            <div class="col-md-3">
                                <label for="commissionRate" class="form-label">{{ _('Commission Rate') }} (%)</label>
                                <input type="number" step="0.1" min="0.5" max="25" class="form-control" id="commissionRate" name="commission_rate" placeholder="2.5" required>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">{{ _('Create') }}</button>
                            </div>
                        </div>
                        <div class="form-text mt-2">{{ _('Creating a currency costs 1000 FC. Commission rate must be between 0.5 percent and 25 percent.') }}</div>
                    </form>
                    <div id="createCurrencyResult" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="currencySearchModal" tabindex="-1" aria-labelledby="currencySearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="currencySearchModalLabel">{{ _('Search Currencies') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="currencySearchInput" placeholder="{{ _('Search currencies...') }}" onkeyup="filterCurrencies()">
                </div>
                <div class="list-group" id="currencyList">
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let adPlaying = false;

document.getElementById('watchAdBtn').addEventListener('click', function() {
    if (adPlaying) return;
    
    const button = this;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Preparing...';
    
    const adVideos = ['ad.mp4', 'ad1.mp4', 'ad2.mp4'];
    const randomAd = adVideos[Math.floor(Math.random() * adVideos.length)];
    
    const videoElement = document.getElementById('fullscreenAdVideo');
    videoElement.src = "{{ url_for('static', filename='') }}" + randomAd;
    
    const modal = document.getElementById('fullscreenAdModal');
    modal.style.display = 'flex';
    
    adPlaying = true;
    
    setTimeout(() => {
        videoElement.volume = 0.25;
        videoElement.play().catch(e => console.log("Autoplay prevented:", e));
    }, 500);
    
    const duration = Math.floor(Math.random() * 46) + 15;
    let timeLeft = duration;
    
    const timerElement = document.getElementById('adTimer');
    const countdownElement = document.getElementById('adCountdown');
    
    document.getElementById('closeAdBtn').style.display = 'none';
    
    const countdownInterval = setInterval(() => {
        timeLeft--;
        timerElement.textContent = 'Ad playing... ' + timeLeft + 's remaining';
        countdownElement.textContent = timeLeft + 's';
        
        if (timeLeft <= 0) {
            clearInterval(countdownInterval);
            document.getElementById('closeAdBtn').style.display = 'block';
            timerElement.textContent = 'Ad finished! Click close to claim reward.';
        }
    }, 1000);
    
    const closeBtn = document.getElementById('closeAdBtn');
    closeBtn.onclick = function() {
        videoElement.pause();
        
        if (timeLeft <= 0) {
            fetch('/watch-ad', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                modal.style.display = 'none';
                
                if (data.success) {
                    document.querySelector('.balance-card h1').textContent = data.balance.toFixed(2) + ' FC';
                    
                    document.getElementById('resultMessage').innerHTML = `
                        <div class="alert alert-success alert-dismissible fade show">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Success!</strong> You earned ${data.reward} FC!
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `;
                } else {
                    document.getElementById('resultMessage').innerHTML = `
                        <div class="alert alert-danger alert-dismissible fade show">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Error:</strong> ${data.message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                modal.style.display = 'none';
                document.getElementById('resultMessage').innerHTML = `
                    <div class="alert alert-danger alert-dismissible fade show">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Error:</strong> Something went wrong!
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-play-circle me-2"></i>Watch Ad & Earn FC';
                adPlaying = false;
            });
        } else {
            timerElement.textContent = 'Please wait! ' + timeLeft + 's remaining to finish ad.';
        }
    };
    
    videoElement.onended = function() {
        if (timeLeft > 0) {
            return;
        }
        document.getElementById('closeAdBtn').style.display = 'block';
        timerElement.textContent = 'Ad finished! Click close to claim reward.';
    };
});

document.addEventListener('DOMContentLoaded', function() {
    fetch('/get_currencies')
    .then(response => response.json())
    .then(currencies => {
        const transferSelect = document.getElementById('transferCurrency');
        
        transferSelect.innerHTML = '<option value="FC">FreshCoin (FC)</option>';
        
        currencies.forEach(currency => {
            if (currency.symbol !== 'FC') {
                const option = document.createElement('option');
                option.value = currency.symbol;
                option.textContent = `${currency.name} (${currency.symbol})`;
                
                transferSelect.appendChild(option);
            }
        });
    })
    .catch(error => {
        console.error('Error loading currencies for transfer:', error);
    });
});

document.getElementById('transferForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = this;
    const formData = new FormData(form);
    
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Sending...';
    
    fetch('/transfer', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const resultDiv = document.getElementById('transferResult');
        
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Success!</strong> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            form.reset();
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Error:</strong> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('transferResult').innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Error:</strong> Something went wrong!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send';
    });
});

document.addEventListener('DOMContentLoaded', function() {
    fetch('/get_currencies')
    .then(response => response.json())
    .then(currencies => {
        const fromSelect = document.getElementById('fromCurrency');
        const toSelect = document.getElementById('toCurrency');
        
        fromSelect.innerHTML = '<option value="FC">FreshCoin (FC)</option>';
        toSelect.innerHTML = '<option value="FC">FreshCoin (FC)</option>';
        
        currencies.forEach(currency => {
            if (currency.symbol !== 'FC') {
                const option1 = document.createElement('option');
                option1.value = currency.symbol;
                option1.textContent = `${currency.name} (${currency.symbol})`;
                
                const option2 = document.createElement('option');
                option2.value = currency.symbol;
                option2.textContent = `${currency.name} (${currency.symbol})`;
                
                fromSelect.appendChild(option1);
                toSelect.appendChild(option2);
            }
        });
    })
    .catch(error => {
        console.error('Error loading currencies:', error);
    });
});

document.getElementById('exchangeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = this;
    const formData = new FormData(form);
    
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Exchanging...';
    
    fetch('/exchange', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const resultDiv = document.getElementById('exchangeResult');
        
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Success!</strong> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            form.reset();
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Error:</strong> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('exchangeResult').innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Error:</strong> Something went wrong!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Exchange';
    });
});

document.getElementById('createCurrencyForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = this;
    const formData = new FormData(form);
    
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Creating...';
    
    fetch('/create_currency', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const resultDiv = document.getElementById('createCurrencyResult');
        
        if (data.success) {
            const currentBalanceStr = document.querySelector('.balance-card h1').textContent.trim();
            const currentBalance = parseFloat(currentBalanceStr.replace(' FC', ''));
            const newBalance = currentBalance - 1000;
            document.querySelector('.balance-card h1').textContent = newBalance.toFixed(2) + ' FC';
            
            resultDiv.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Success!</strong> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            form.reset();
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Error:</strong> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('createCurrencyResult').innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Error:</strong> Something went wrong!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create';
    });
});

let allCurrencies = [];
let targetDropdown = '';

function toggleCurrencySearch(dropdownType) {
    targetDropdown = dropdownType;
    
    if (allCurrencies.length === 0) {
        fetch('/get_currencies')
        .then(response => response.json())
        .then(currencies => {
            allCurrencies = currencies;
            populateCurrencySearchList();
            
            const modal = new bootstrap.Modal(document.getElementById('currencySearchModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error loading currencies:', error);
        });
    } else {
        populateCurrencySearchList();
        
        const modal = new bootstrap.Modal(document.getElementById('currencySearchModal'));
        modal.show();
    }
}

function populateCurrencySearchList() {
    const currencyList = document.getElementById('currencyList');
    currencyList.innerHTML = '';
    
    allCurrencies.forEach(currency => {
        const listItem = document.createElement('button');
        listItem.className = 'list-group-item list-group-item-action';
        listItem.type = 'button';
        listItem.innerHTML = `
            <div class="d-flex justify-content-between">
                <div>
                    <strong>${currency.name}</strong>
                    <span class="text-muted">(${currency.symbol})</span>
                </div>
            </div>
        `;
        
        listItem.addEventListener('click', function() {
            if (targetDropdown === 'from') {
                document.getElementById('fromCurrency').value = currency.symbol;
            } else if (targetDropdown === 'to') {
                document.getElementById('toCurrency').value = currency.symbol;
            } else if (targetDropdown === 'transfer') {
                document.getElementById('transferCurrency').value = currency.symbol;
            }
            
            bootstrap.Modal.getInstance(document.getElementById('currencySearchModal')).hide();
        });
        
        currencyList.appendChild(listItem);
    });
}

function filterCurrencies() {
    const searchInput = document.getElementById('currencySearchInput').value.toLowerCase();
    const currencyList = document.getElementById('currencyList');
    
    Array.from(currencyList.children).forEach(item => {
        const currencyName = item.querySelector('strong').textContent.toLowerCase();
        const currencySymbol = item.querySelector('.text-muted').textContent.toLowerCase();
        
        if (currencyName.includes(searchInput) || currencySymbol.includes(searchInput)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function toggleTransferCurrencySearch() {
    targetDropdown = 'transfer';
    
    if (allCurrencies.length === 0) {
        fetch('/get_currencies')
        .then(response => response.json())
        .then(currencies => {
            allCurrencies = currencies;
            populateCurrencySearchList();
            
            const modal = new bootstrap.Modal(document.getElementById('currencySearchModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error loading currencies:', error);
        });
    } else {
        populateCurrencySearchList();
        
        const modal = new bootstrap.Modal(document.getElementById('currencySearchModal'));
        modal.show();
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, 150 * index);
    });
});
</script>
{% endblock %}